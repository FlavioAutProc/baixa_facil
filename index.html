<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BaixaPro - Sistema de Registro</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/jspdf@latest/dist/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <!-- QuaggaJS para leitura de código de barras -->
    <script src="https://unpkg.com/quagga@0.12.1/dist/quagga.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #f5f5f7;
            color: #1d1d1f;
            line-height: 1.5;
            max-width: 100%;
            overflow-x: hidden;
            padding-top: env(safe-area-inset-top);
            padding-bottom: calc(env(safe-area-inset-bottom) + 70px); /* Espaço para o menu inferior */
        }
        
        .app-container {
            max-width: 500px;
            margin: 0 auto;
            background: #fff;
            min-height: 100vh;
            box-shadow: 0 0 30px rgba(0,0,0,0.05);
            position: relative;
        }
        
        /* Header estilo app */
        .app-header {
            background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
            color: white;
            padding: 16px 20px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .app-title {
            font-size: 20px;
            font-weight: 700;
        }
        
        .app-subtitle {
            font-size: 13px;
            opacity: 0.9;
            margin-top: 2px;
        }
        
        .header-actions {
            display: flex;
            gap: 16px;
        }
        
        .header-btn {
            background: transparent;
            border: none;
            color: white;
            font-size: 20px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.2s;
        }
        
        .header-btn:active {
            background: rgba(255,255,255,0.2);
        }
        
        /* Conteúdo das abas */
        .tab-content {
            display: none;
            padding: 0;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Menu inferior */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #e5e5e7;
            display: flex;
            justify-content: space-around;
            padding: 12px 0;
            z-index: 1000;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            max-width: 500px;
            margin: 0 auto;
            padding-bottom: calc(12px + env(safe-area-inset-bottom));
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: none;
            border: none;
            color: #8e8e93;
            font-size: 12px;
            gap: 4px;
            padding: 8px 16px;
            border-radius: 12px;
            transition: all 0.2s;
            flex: 1;
            max-width: 100px;
        }
        
        .nav-item i {
            font-size: 20px;
            margin-bottom: 2px;
        }
        
        .nav-item.active {
            color: #2563eb;
            background: rgba(37, 99, 235, 0.1);
        }
        
        .nav-item:active {
            transform: scale(0.95);
        }
        
        /* Seção de formulário */
        .form-section {
            padding: 20px;
        }
        
        .section-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-title i {
            color: #2563eb;
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        .input-label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 15px;
        }
        
        .required::after {
            content: " *";
            color: #ef4444;
        }
        
        .input-field {
            width: 100%;
            padding: 16px;
            border: 1.5px solid #d1d5db;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.2s;
            background: white;
            -webkit-appearance: none;
        }
        
        .input-field:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        .input-field.error {
            border-color: #ef4444;
        }
        
        .error-message {
            color: #ef4444;
            font-size: 14px;
            margin-top: 6px;
            display: none;
        }
        
        /* Scanner - CORRIGIDO */
        .scanner-container {
            position: relative;
            margin-bottom: 20px;
            border-radius: 12px;
            overflow: hidden;
        }
        
        #scanner-viewport {
            width: 100%;
            height: 300px;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        #interactive.viewport {
            width: 100%;
            height: 100%;
            position: relative;
            display: none;
        }
        
        #interactive.viewport canvas, #interactive.viewport video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            position: absolute;
            top: 0;
            left: 0;
        }
        
        #scanner-placeholder {
            color: white;
            text-align: center;
            padding: 20px;
            z-index: 2;
        }
        
        .scanner-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }
        
        .scanner-line {
            position: absolute;
            width: 80%;
            height: 3px;
            background: #2563eb;
            top: 50%;
            left: 10%;
            animation: scan 2s infinite linear;
            box-shadow: 0 0 10px rgba(37, 99, 235, 0.7);
        }
        
        .scanner-corners {
            position: absolute;
            top: 50%;
            left: 10%;
            width: 80%;
            height: 120px;
            transform: translateY(-50%);
            border: 2px solid #2563eb;
            border-radius: 8px;
        }
        
        @keyframes scan {
            0%, 100% { top: 20%; }
            50% { top: 80%; }
        }
        
        .camera-controls {
            display: none;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        
        .scanner-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            padding: 18px;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 16px;
            margin-top: 10px;
            transition: all 0.2s;
        }
        
        .scanner-btn:active {
            background: #1e40af;
            transform: scale(0.98);
        }
        
        .scanner-btn.scanner-active {
            background: #10b981;
        }
        
        .scanner-btn.scanner-active:active {
            background: #0da271;
        }
        
        .capture-btn {
            flex: 1;
            padding: 14px;
            background: #10b981;
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            min-width: 160px;
        }
        
        .stop-btn {
            padding: 14px 20px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            min-width: 120px;
        }
        
        /* Botões de ação */
        .action-buttons {
            display: flex;
            gap: 12px;
            margin-top: 30px;
        }
        
        .btn {
            flex: 1;
            padding: 18px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.2s;
        }
        
        .btn:active {
            transform: scale(0.98);
        }
        
        .btn-primary {
            background: #2563eb;
            color: white;
        }
        
        .btn-primary:active {
            background: #1e40af;
        }
        
        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
        }
        
        .btn-secondary:active {
            background: #e5e7eb;
        }
        
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        
        .btn-danger:active {
            background: #dc2626;
        }
        
        /* Lista de registros - MELHORADA */
        .registros-container {
            padding: 0;
        }
        
        .registros-header {
            padding: 20px 20px 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .filtros-container {
            padding: 0 20px 10px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .filtro-btn {
            padding: 8px 16px;
            background: #f3f4f6;
            border: none;
            border-radius: 20px;
            font-size: 14px;
            color: #4b5563;
            transition: all 0.2s;
        }
        
        .filtro-btn.active {
            background: #2563eb;
            color: white;
        }
        
        .registros-list {
            max-height: calc(100vh - 300px);
            overflow-y: auto;
        }
        
        .registro-item {
            padding: 16px 20px;
            border-bottom: 1px solid #e5e5e7;
            background: white;
            transition: background 0.2s;
            position: relative;
        }
        
        .registro-item:active {
            background: #f9fafb;
        }
        
        .registro-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            align-items: flex-start;
        }
        
        .registro-produto {
            font-weight: 700;
            font-size: 16px;
            flex: 1;
        }
        
        .registro-actions {
            display: flex;
            gap: 8px;
        }
        
        .registro-action-btn {
            background: none;
            border: none;
            color: #6b7280;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            transition: all 0.2s;
        }
        
        .registro-action-btn:active {
            background: #f3f4f6;
        }
        
        .registro-action-btn.delete {
            color: #ef4444;
        }
        
        .registro-data {
            font-size: 13px;
            color: #6b7280;
            margin-bottom: 8px;
        }
        
        .registro-details {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            font-size: 14px;
            color: #4b5563;
        }
        
        .registro-detail {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        /* Modal de confirmação */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
            display: none;
        }
        
        .modal {
            background: white;
            border-radius: 16px;
            width: 100%;
            max-width: 400px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: modalAppear 0.3s;
        }
        
        @keyframes modalAppear {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        
        .modal-header {
            padding: 24px 24px 0;
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .modal-body {
            padding: 20px 24px;
            max-height: 60vh;
            overflow-y: auto;
        }
        
        .modal-actions {
            display: flex;
            border-top: 1px solid #e5e5e7;
        }
        
        .modal-btn {
            flex: 1;
            padding: 18px;
            background: none;
            border: none;
            font-weight: 600;
            font-size: 16px;
        }
        
        .modal-btn:active {
            background-color: #f9fafb;
        }
        
        .modal-btn-primary {
            color: #2563eb;
        }
        
        .modal-btn-danger {
            color: #ef4444;
        }
        
        /* Resumo */
        .resumo-container {
            padding: 20px;
        }
        
        .resumo-card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .resumo-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            color: #4b5563;
        }
        
        .resumo-value {
            font-size: 28px;
            font-weight: 700;
            color: #1d1d1f;
        }
        
        .resumo-stats {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .stat-item {
            flex: 1;
            min-width: 120px;
            background: #f8fafc;
            padding: 12px;
            border-radius: 12px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #2563eb;
        }
        
        .stat-label {
            font-size: 12px;
            color: #6b7280;
            margin-top: 4px;
        }
        
        /* Para desktop */
        @media (min-width: 768px) {
            .app-container {
                margin: 20px auto;
                min-height: calc(100vh - 40px);
                border-radius: 20px;
                overflow: hidden;
            }
            
            .bottom-nav {
                max-width: 500px;
                border-radius: 20px 20px 0 0;
                margin: 0 auto;
                left: 50%;
                transform: translateX(-50%);
            }
        }
        
        /* Feedback visual */
        .toast {
            position: fixed;
            bottom: 90px;
            left: 50%;
            transform: translateX(-50%);
            background: #10b981;
            color: white;
            padding: 14px 24px;
            border-radius: 12px;
            font-weight: 600;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            z-index: 1001;
            display: flex;
            align-items: center;
            gap: 10px;
            display: none;
            max-width: 90%;
            text-align: center;
            animation: toastSlide 0.3s ease;
        }
        
        @keyframes toastSlide {
            from { bottom: 50px; opacity: 0; }
            to { bottom: 90px; opacity: 1; }
        }
        
        .toast.error {
            background: #ef4444;
        }
        
        .toast.warning {
            background: #f59e0b;
        }
        
        /* Indicador de leitura */
        .scan-indicator {
            position: absolute;
            bottom: 20px;
            left: 0;
            right: 0;
            text-align: center;
            color: white;
            font-size: 14px;
            background: rgba(0,0,0,0.7);
            padding: 8px;
            z-index: 2;
            display: none;
        }
        
        /* Datalist styling */
        .suggestions-list {
            position: absolute;
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            width: calc(100% - 32px);
            z-index: 100;
            display: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .suggestion-item {
            padding: 12px 16px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .suggestion-item:hover {
            background: #f3f4f6;
        }
        
        /* Configurações */
        .config-container {
            padding: 20px;
        }
        
        .config-section {
            margin-bottom: 30px;
        }
        
        .config-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #374151;
        }
        
        .config-option {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0;
            border-bottom: 1px solid #e5e5e7;
        }
        
        .config-option:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header do app -->
        <header class="app-header">
            <div class="header-content">
                <div>
                    <div class="app-title">BaixaPro</div>
                    <div class="app-subtitle">Sistema de baixa para produção</div>
                </div>
                <div class="header-actions">
                    <button class="header-btn" id="btnExportar">
                        <i class="fas fa-file-export"></i>
                    </button>
                    <button class="header-btn" id="btnConfig">
                        <i class="fas fa-cog"></i>
                    </button>
                </div>
            </div>
        </header>
        
        <!-- Conteúdo: Registrar -->
        <section id="registrar" class="tab-content active">
            <div class="form-section">
                <div class="section-title">
                    <i class="fas fa-box-open"></i>
                    <span>Novo Registro de Produto</span>
                </div>
                
                <!-- Leitor de código de barras CORRIGIDO -->
                <div class="scanner-container" id="scannerContainer">
                    <div id="scanner-viewport">
                        <!-- Visualização da câmera (QuaggaJS usa esta div) -->
                        <div id="interactive" class="viewport"></div>
                        
                        <!-- Placeholder quando câmera não está ativa -->
                        <div id="scanner-placeholder">
                            <i class="fas fa-barcode" style="font-size: 48px; margin-bottom: 16px; opacity: 0.7;"></i>
                            <p>Clique no botão abaixo para ativar o leitor</p>
                        </div>
                        
                        <!-- Overlay do scanner -->
                        <div class="scanner-overlay">
                            <div class="scanner-corners"></div>
                            <div class="scanner-line"></div>
                        </div>
                        
                        <!-- Indicador de leitura -->
                        <div class="scan-indicator" id="scanIndicator">
                            <i class="fas fa-search"></i> Procurando código de barras...
                        </div>
                    </div>
                    
                    <!-- Controles da câmera -->
                    <div class="camera-controls" id="cameraControls">
                        <button class="capture-btn" id="captureBtn">
                            <i class="fas fa-camera"></i> Capturar Manual
                        </button>
                        <button class="stop-btn" id="stopBtn">
                            <i class="fas fa-stop"></i> Parar
                        </button>
                    </div>
                    
                    <button class="scanner-btn" id="btnToggleScanner">
                        <i class="fas fa-camera"></i>
                        Ativar Leitor de Código de Barras
                    </button>
                </div>
                
                <!-- Formulário -->
                <div class="input-group">
                    <label class="input-label required" for="produto">Produto</label>
                    <input type="text" id="produto" class="input-field" placeholder="Digite o nome do produto" list="produto-suggestions">
                    <div class="suggestions-list" id="produto-suggestions"></div>
                    <div class="error-message" id="produtoError">O nome do produto é obrigatório</div>
                </div>
                
                <div class="input-group">
                    <label class="input-label required" for="codigo">Código de Barras</label>
                    <input type="text" id="codigo" class="input-field" placeholder="Digite ou escaneie o código">
                    <div class="error-message" id="codigoError">O código de barras é obrigatório</div>
                    <div class="error-message" id="codigoDuplicadoError" style="color: #f59e0b;">Este código já foi registrado hoje</div>
                </div>
                
                <div class="input-group">
                    <label class="input-label required" for="quantidade">Quantidade</label>
                    <input type="number" id="quantidade" class="input-field" placeholder="Digite a quantidade" min="1" value="1">
                    <div class="error-message" id="quantidadeError">A quantidade deve ser entre 1 e 999</div>
                </div>
                
                <div class="input-group">
                    <label class="input-label required" for="setor">Setor de Origem</label>
                    <input type="text" id="setor" class="input-field" placeholder="Digite o setor de origem" list="setor-suggestions">
                    <div class="suggestions-list" id="setor-suggestions"></div>
                    <div class="error-message" id="setorError">O setor de origem é obrigatório</div>
                </div>
                
                <div class="input-group">
                    <label class="input-label required" for="colaborador">Colaborador Responsável</label>
                    <input type="text" id="colaborador" class="input-field" placeholder="Digite o nome do colaborador" list="colaborador-suggestions">
                    <div class="suggestions-list" id="colaborador-suggestions"></div>
                    <div class="error-message" id="colaboradorError">O colaborador responsável é obrigatório</div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-secondary" id="btnLimpar">
                        <i class="fas fa-eraser"></i> Limpar
                    </button>
                    <button class="btn btn-primary" id="btnSalvar">
                        <i class="fas fa-check"></i> Salvar Registro
                    </button>
                </div>
            </div>
        </section>
        
        <!-- Conteúdo: Registros -->
        <section id="registros" class="tab-content">
            <div class="registros-container">
                <div class="registros-header">
                    <div class="section-title">
                        <i class="fas fa-history"></i>
                        <span>Registros</span>
                    </div>
                    <div>
                        <button class="registro-action-btn" id="btnFiltrar">
                            <i class="fas fa-filter"></i>
                        </button>
                    </div>
                </div>
                
                <div class="filtros-container" id="filtrosContainer" style="display: none;">
                    <button class="filtro-btn active" data-filtro="todos">Todos</button>
                    <button class="filtro-btn" data-filtro="hoje">Hoje</button>
                    <button class="filtro-btn" data-filtro="semana">Esta Semana</button>
                    <button class="filtro-btn" data-filtro="mes">Este Mês</button>
                </div>
                
                <div class="registros-list" id="listaRegistros">
                    <!-- Registros serão inseridos aqui via JavaScript -->
                </div>
                
                <div style="padding: 40px 20px; text-align: center; color: #6b7280;" id="semRegistros">
                    <i class="fas fa-inbox" style="font-size: 48px; margin-bottom: 16px; opacity: 0.5;"></i>
                    <p>Nenhum registro encontrado</p>
                    <button class="btn btn-secondary" style="margin-top: 16px;" id="btnNovoRegistro">
                        <i class="fas fa-plus"></i> Novo Registro
                    </button>
                </div>
            </div>
        </section>
        
        <!-- Conteúdo: Resumo -->
        <section id="resumo" class="tab-content">
            <div class="resumo-container">
                <div class="section-title">
                    <i class="fas fa-chart-pie"></i>
                    <span>Resumo e Estatísticas</span>
                </div>
                
                <div class="resumo-stats">
                    <div class="stat-item">
                        <div class="stat-value" id="totalHoje">0</div>
                        <div class="stat-label">Hoje</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="totalSemana">0</div>
                        <div class="stat-label">Esta Semana</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="totalMes">0</div>
                        <div class="stat-label">Este Mês</div>
                    </div>
                </div>
                
                <div class="resumo-card">
                    <div class="resumo-title">Produto Mais Retirado</div>
                    <div class="resumo-value" id="produtoMaisRetirado">-</div>
                </div>
                
                <div class="resumo-card">
                    <div class="resumo-title">Setor com Mais Retiradas</div>
                    <div class="resumo-value" id="setorMaisRetirado">-</div>
                </div>
                
                <div class="resumo-card">
                    <div class="resumo-title">Colaborador com Mais Registros</div>
                    <div class="resumo-value" id="colaboradorMaisAtivo">-</div>
                </div>
                
                <div style="margin-top: 30px;">
                    <button class="btn btn-primary" id="btnExportarPDF" style="width: 100%;">
                        <i class="fas fa-file-pdf"></i> Gerar Relatório em PDF
                    </button>
                    <button class="btn btn-secondary" id="btnCompartilhar" style="width: 100%; margin-top: 12px;">
                        <i class="fas fa-share-alt"></i> Compartilhar Relatório
                    </button>
                </div>
            </div>
        </section>
        
        <!-- Conteúdo: Configurações -->
        <section id="configuracoes" class="tab-content">
            <div class="config-container">
                <div class="section-title">
                    <i class="fas fa-cog"></i>
                    <span>Configurações</span>
                </div>
                
                <div class="config-section">
                    <div class="config-title">Dados do Sistema</div>
                    
                    <div class="config-option">
                        <span>Total de Registros</span>
                        <span id="totalRegistrosConfig">0</span>
                    </div>
                    
                    <div class="config-option">
                        <span>Dados no Dispositivo</span>
                        <span id="tamanhoDados">0 KB</span>
                    </div>
                    
                    <div class="config-option">
                        <span>Versão do Sistema</span>
                        <span>2.0</span>
                    </div>
                </div>
                
                <div class="config-section">
                    <div class="config-title">Gerenciamento de Dados</div>
                    
                    <button class="btn btn-secondary" id="btnExportarBackup" style="width: 100%; margin-bottom: 12px;">
                        <i class="fas fa-download"></i> Exportar Backup
                    </button>
                    
                    <button class="btn btn-secondary" id="btnImportarBackup" style="width: 100%; margin-bottom: 12px;">
                        <i class="fas fa-upload"></i> Importar Backup
                    </button>
                    
                    <button class="btn btn-danger" id="btnLimparDados" style="width: 100%;">
                        <i class="fas fa-trash"></i> Limpar Todos os Dados
                    </button>
                </div>
                
                <div class="config-section">
                    <div class="config-title">Sugestões Automáticas</div>
                    
                    <div class="config-option">
                        <span>Salvar sugestões de preenchimento</span>
                        <input type="checkbox" id="sugestoesAtivas" checked>
                    </div>
                </div>
            </div>
        </section>
    </div>
    
    <!-- Menu inferior -->
    <nav class="bottom-nav">
        <button class="nav-item active" data-tab="registrar">
            <i class="fas fa-plus-circle"></i>
            <span>Registrar</span>
        </button>
        <button class="nav-item" data-tab="registros">
            <i class="fas fa-list"></i>
            <span>Registros</span>
        </button>
        <button class="nav-item" data-tab="resumo">
            <i class="fas fa-chart-pie"></i>
            <span>Resumo</span>
        </button>
        <button class="nav-item" data-tab="configuracoes">
            <i class="fas fa-cog"></i>
            <span>Configurações</span>
        </button>
    </nav>
    
    <!-- Modal de confirmação -->
    <div class="modal-overlay" id="confirmModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Confirmar Registro</div>
                <div style="color: #6b7280; font-size: 14px;">Revise os dados antes de confirmar</div>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 16px;">
                    <div style="font-weight: 600; margin-bottom: 4px;">Produto:</div>
                    <div id="confirmProduto">-</div>
                </div>
                <div style="margin-bottom: 16px;">
                    <div style="font-weight: 600; margin-bottom: 4px;">Código:</div>
                    <div id="confirmCodigo">-</div>
                </div>
                <div style="margin-bottom: 16px;">
                    <div style="font-weight: 600; margin-bottom: 4px;">Quantidade:</div>
                    <div id="confirmQuantidade">-</div>
                </div>
                <div style="margin-bottom: 16px;">
                    <div style="font-weight: 600; margin-bottom: 4px;">Setor de Origem:</div>
                    <div id="confirmSetor">-</div>
                </div>
                <div style="margin-bottom: 16px;">
                    <div style="font-weight: 600; margin-bottom: 4px;">Colaborador:</div>
                    <div id="confirmColaborador">-</div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="modal-btn" id="btnCancelar">Cancelar</button>
                <button class="modal-btn modal-btn-primary" id="btnConfirmar">Confirmar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal de confirmação de exclusão -->
    <div class="modal-overlay" id="deleteModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Confirmar Exclusão</div>
                <div style="color: #6b7280; font-size: 14px;">Esta ação não pode ser desfeita</div>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 16px;">
                    <i class="fas fa-exclamation-triangle" style="color: #ef4444; font-size: 48px; display: block; text-align: center; margin-bottom: 16px;"></i>
                    <p>Tem certeza que deseja excluir este registro?</p>
                    <div id="deleteRegistroInfo" style="background: #fef2f2; padding: 12px; border-radius: 8px; margin-top: 12px; font-size: 14px;"></div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="modal-btn" id="btnCancelarDelete">Cancelar</button>
                <button class="modal-btn modal-btn-danger" id="btnConfirmarDelete">Excluir</button>
            </div>
        </div>
    </div>
    
    <!-- Modal de limpeza de dados -->
    <div class="modal-overlay" id="clearDataModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Limpar Todos os Dados</div>
                <div style="color: #6b7280; font-size: 14px;">Esta ação é irreversível</div>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 16px;">
                    <i class="fas fa-exclamation-triangle" style="color: #ef4444; font-size: 48px; display: block; text-align: center; margin-bottom: 16px;"></i>
                    <p><strong>Atenção:</strong> Todos os registros serão permanentemente excluídos.</p>
                    <p style="margin-top: 8px;">Você tem certeza que deseja continuar?</p>
                    <div style="background: #fef2f2; padding: 12px; border-radius: 8px; margin-top: 12px; font-size: 14px;">
                        <p><i class="fas fa-info-circle"></i> Total de registros: <span id="clearDataCount">0</span></p>
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="modal-btn" id="btnCancelarClear">Cancelar</button>
                <button class="modal-btn modal-btn-danger" id="btnConfirmarClear">Limpar Tudo</button>
            </div>
        </div>
    </div>
    
    <!-- Toast de feedback -->
    <div class="toast" id="toast">
        <i class="fas fa-check"></i>
        <span id="toastMessage">Registro salvo com sucesso!</span>
    </div>

    <!-- Input oculto para importação de backup -->
    <input type="file" id="importFileInput" accept=".json" style="display: none;">

    <script>
        // Estado da aplicação
        const estado = {
            scannerAtivo: false,
            quaggaInicializado: false,
            registros: JSON.parse(localStorage.getItem('registrosProdutos')) || [],
            codigosRegistradosHoje: new Set(),
            scanTimeout: null,
            filtroAtivo: 'todos',
            sugestoes: JSON.parse(localStorage.getItem('sugestoesBaixaPro')) || {
                produtos: [],
                setores: [],
                colaboradores: []
            },
            registroParaDeletar: null
        };
        
        // Configuração do QuaggaJS - CORRIGIDA
        const quaggaConfig = {
            inputStream: {
                name: "Live",
                type: "LiveStream",
                target: document.querySelector("#interactive"),
                constraints: {
                    facingMode: "environment",
                    width: { min: 640, ideal: 1280, max: 1920 },
                    height: { min: 480, ideal: 720, max: 1080 }
                },
                area: {
                    top: "25%",
                    right: "10%",
                    left: "10%",
                    bottom: "25%"
                }
            },
            decoder: {
                readers: [
                    "code_128_reader",
                    "ean_reader",
                    "ean_8_reader",
                    "code_39_reader",
                    "upc_reader",
                    "upc_e_reader",
                    "codabar_reader",
                    "i2of5_reader"
                ],
                multiple: false
            },
            locator: {
                patchSize: "medium",
                halfSample: true
            },
            locate: true,
            frequency: 10
        };
        
        // Inicialização
        document.addEventListener('DOMContentLoaded', function() {
            // Atualizar lista de códigos registrados hoje
            atualizarCodigosRegistradosHoje();
            
            // Configurar navegação por abas
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    
                    // Parar scanner se estiver ativo
                    if (estado.scannerAtivo) {
                        stopScanner();
                    }
                    
                    // Ativar aba clicada
                    document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Mostrar conteúdo da aba
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    document.getElementById(tabId).classList.add('active');
                    
                    // Atualizar dados conforme a aba
                    if (tabId === 'registros') {
                        carregarRegistros();
                    } else if (tabId === 'resumo') {
                        atualizarResumo();
                    } else if (tabId === 'configuracoes') {
                        atualizarConfiguracoes();
                    }
                });
            });
            
            // Configurar botões
            document.getElementById('btnSalvar').addEventListener('click', validarFormulario);
            document.getElementById('btnLimpar').addEventListener('click', limparFormulario);
            document.getElementById('btnToggleScanner').addEventListener('click', toggleScanner);
            document.getElementById('btnExportarPDF').addEventListener('click', exportarPDF);
            document.getElementById('btnCompartilhar').addEventListener('click', compartilharRelatorio);
            document.getElementById('btnCancelar').addEventListener('click', fecharModal);
            document.getElementById('btnConfirmar').addEventListener('click', salvarRegistro);
            document.getElementById('captureBtn').addEventListener('click', capturarManualmente);
            document.getElementById('stopBtn').addEventListener('click', stopScanner);
            document.getElementById('btnFiltrar').addEventListener('click', toggleFiltros);
            document.getElementById('btnNovoRegistro').addEventListener('click', () => {
                document.querySelector('.nav-item[data-tab="registrar"]').click();
            });
            document.getElementById('btnExportarBackup').addEventListener('click', exportarBackup);
            document.getElementById('btnImportarBackup').addEventListener('click', () => {
                document.getElementById('importFileInput').click();
            });
            document.getElementById('btnLimparDados').addEventListener('click', mostrarModalLimpeza);
            document.getElementById('btnCancelarDelete').addEventListener('click', fecharDeleteModal);
            document.getElementById('btnConfirmarDelete').addEventListener('click', confirmarExclusao);
            document.getElementById('btnCancelarClear').addEventListener('click', fecharClearModal);
            document.getElementById('btnConfirmarClear').addEventListener('click', confirmarLimpeza);
            document.getElementById('btnExportar').addEventListener('click', () => {
                document.querySelector('.nav-item[data-tab="resumo"]').click();
            });
            document.getElementById('btnConfig').addEventListener('click', () => {
                document.querySelector('.nav-item[data-tab="configuracoes"]').click();
            });
            
            // Configurar validação em tempo real
            document.getElementById('codigo').addEventListener('input', validarCodigoUnico);
            document.getElementById('quantidade').addEventListener('input', validarQuantidade);
            
            // Configurar sugestões automáticas
            configurarSugestoes();
            
            // Configurar filtros
            document.querySelectorAll('.filtro-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.filtro-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    estado.filtroAtivo = this.getAttribute('data-filtro');
                    carregarRegistros();
                });
            });
            
            // Configurar importação de backup
            document.getElementById('importFileInput').addEventListener('change', importarBackup);
            
            // Carregar registros iniciais
            carregarRegistros();
            atualizarResumo();
            atualizarConfiguracoes();
            
            // Adicionar listener para quando a página perder foco
            document.addEventListener('visibilitychange', function() {
                if (document.hidden && estado.scannerAtivo) {
                    stopScanner();
                }
            });
        });
        
        // Configurar sugestões automáticas
        function configurarSugestoes() {
            const campos = ['produto', 'setor', 'colaborador'];
            
            campos.forEach(campo => {
                const input = document.getElementById(campo);
                const suggestionsList = document.getElementById(`${campo}-suggestions`);
                
                // Mostrar sugestões ao focar
                input.addEventListener('focus', function() {
                    atualizarSugestoes(campo);
                    suggestionsList.style.display = 'block';
                });
                
                // Ocultar sugestões ao perder o foco
                input.addEventListener('blur', function() {
                    setTimeout(() => {
                        suggestionsList.style.display = 'none';
                    }, 200);
                });
                
                // Filtrar sugestões ao digitar
                input.addEventListener('input', function() {
                    atualizarSugestoes(campo);
                    suggestionsList.style.display = 'block';
                });
            });
        }
        
        // Atualizar lista de sugestões
        function atualizarSugestoes(campo) {
            const input = document.getElementById(campo);
            const suggestionsList = document.getElementById(`${campo}-suggestions`);
            const valor = input.value.toLowerCase();
            
            let sugestoes = estado.sugestoes[campo + 's'] || [];
            
            // Filtrar sugestões baseado no que foi digitado
            const sugestoesFiltradas = sugestoes.filter(s => 
                s.toLowerCase().includes(valor)
            ).slice(0, 5); // Limitar a 5 sugestões
            
            // Gerar HTML das sugestões
            suggestionsList.innerHTML = sugestoesFiltradas.map(s => 
                `<div class="suggestion-item" data-value="${s}">${s}</div>`
            ).join('');
            
            // Adicionar eventos de clique às sugestões
            suggestionsList.querySelectorAll('.suggestion-item').forEach(item => {
                item.addEventListener('mousedown', function(e) {
                    e.preventDefault();
                    input.value = this.getAttribute('data-value');
                    suggestionsList.style.display = 'none';
                    input.focus();
                });
            });
        }
        
        // Adicionar sugestão
        function adicionarSugestao(campo, valor) {
            if (!document.getElementById('sugestoesAtivas').checked) return;
            
            const lista = estado.sugestoes[campo + 's'];
            const valorTrim = valor.trim();
            
            if (valorTrim && !lista.includes(valorTrim)) {
                lista.push(valorTrim);
                // Manter apenas as últimas 20 sugestões
                if (lista.length > 20) {
                    estado.sugestoes[campo + 's'] = lista.slice(-20);
                }
                salvarSugestoes();
            }
        }
        
        // Salvar sugestões no localStorage
        function salvarSugestoes() {
            localStorage.setItem('sugestoesBaixaPro', JSON.stringify(estado.sugestoes));
        }
        
        // Atualizar lista de códigos registrados hoje
        function atualizarCodigosRegistradosHoje() {
            const hoje = new Date().toDateString();
            estado.codigosRegistradosHoje.clear();
            
            estado.registros.forEach(registro => {
                const dataRegistro = new Date(registro.dataHora).toDateString();
                if (dataRegistro === hoje) {
                    estado.codigosRegistradosHoje.add(registro.codigo);
                }
            });
        }
        
        // Carregar registros na lista - MELHORADA
        function carregarRegistros() {
            const listaRegistros = document.getElementById('listaRegistros');
            const semRegistros = document.getElementById('semRegistros');
            
            // Filtrar registros conforme filtro ativo
            let registrosFiltrados = filtrarRegistros(estado.registros, estado.filtroAtivo);
            
            // Ordenar registros por data (mais recente primeiro)
            const registrosOrdenados = registrosFiltrados.sort((a, b) => 
                new Date(b.dataHora) - new Date(a.dataHora)
            );
            
            if (registrosOrdenados.length === 0) {
                semRegistros.style.display = 'block';
                listaRegistros.innerHTML = '';
                return;
            }
            
            semRegistros.style.display = 'none';
            
            let html = '';
            registrosOrdenados.forEach((registro, index) => {
                const data = new Date(registro.dataHora);
                const dataFormatada = data.toLocaleDateString('pt-BR');
                const horaFormatada = data.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                
                html += `
                    <div class="registro-item" data-id="${registro.id}">
                        <div class="registro-header">
                            <div class="registro-produto">${registro.produto}</div>
                            <div class="registro-actions">
                                <button class="registro-action-btn delete" data-id="${registro.id}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div class="registro-data">${dataFormatada} ${horaFormatada}</div>
                        <div class="registro-details">
                            <div class="registro-detail">
                                <i class="fas fa-barcode"></i>
                                <span>${registro.codigo}</span>
                            </div>
                            <div class="registro-detail">
                                <i class="fas fa-box"></i>
                                <span>${registro.quantidade} un.</span>
                            </div>
                            <div class="registro-detail">
                                <i class="fas fa-warehouse"></i>
                                <span>${registro.setor}</span>
                            </div>
                            <div class="registro-detail">
                                <i class="fas fa-user"></i>
                                <span>${registro.colaborador}</span>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            listaRegistros.innerHTML = html;
            
            // Adicionar evento de clique para exclusão
            document.querySelectorAll('.registro-action-btn.delete').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const id = this.getAttribute('data-id');
                    mostrarModalExclusao(id);
                });
            });
            
            // Adicionar evento de clique para detalhes
            document.querySelectorAll('.registro-item').forEach(item => {
                item.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    mostrarDetalhesRegistro(id);
                });
            });
        }
        
        // Filtrar registros por período
        function filtrarRegistros(registros, filtro) {
            const agora = new Date();
            const hoje = new Date(agora.getFullYear(), agora.getMonth(), agora.getDate());
            const inicioSemana = new Date(hoje);
            inicioSemana.setDate(hoje.getDate() - hoje.getDay());
            const inicioMes = new Date(agora.getFullYear(), agora.getMonth(), 1);
            
            return registros.filter(registro => {
                const dataRegistro = new Date(registro.dataHora);
                
                switch(filtro) {
                    case 'hoje':
                        return dataRegistro >= hoje;
                    case 'semana':
                        return dataRegistro >= inicioSemana;
                    case 'mes':
                        return dataRegistro >= inicioMes;
                    default:
                        return true; // 'todos'
                }
            });
        }
        
        // Toggle filtros
        function toggleFiltros() {
            const filtrosContainer = document.getElementById('filtrosContainer');
            filtrosContainer.style.display = filtrosContainer.style.display === 'none' ? 'flex' : 'none';
        }
        
        // Atualizar resumo - MELHORADA
        function atualizarResumo() {
            const agora = new Date();
            const hoje = new Date(agora.getFullYear(), agora.getMonth(), agora.getDate());
            const inicioSemana = new Date(hoje);
            inicioSemana.setDate(hoje.getDate() - hoje.getDay());
            const inicioMes = new Date(agora.getFullYear(), agora.getMonth(), 1);
            
            // Calcular totais por período
            const totalHoje = estado.registros
                .filter(r => new Date(r.dataHora) >= hoje)
                .reduce((total, r) => total + parseInt(r.quantidade), 0);
            
            const totalSemana = estado.registros
                .filter(r => new Date(r.dataHora) >= inicioSemana)
                .reduce((total, r) => total + parseInt(r.quantidade), 0);
            
            const totalMes = estado.registros
                .filter(r => new Date(r.dataHora) >= inicioMes)
                .reduce((total, r) => total + parseInt(r.quantidade), 0);
            
            // Atualizar totais
            document.getElementById('totalHoje').textContent = totalHoje;
            document.getElementById('totalSemana').textContent = totalSemana;
            document.getElementById('totalMes').textContent = totalMes;
            
            // Produto mais retirado (últimos 30 dias)
            const ultimos30Dias = new Date();
            ultimos30Dias.setDate(ultimos30Dias.getDate() - 30);
            
            const registrosRecentes = estado.registros.filter(r => 
                new Date(r.dataHora) >= ultimos30Dias
            );
            
            if (registrosRecentes.length > 0) {
                // Produto mais retirado
                const produtosContagem = {};
                registrosRecentes.forEach(registro => {
                    produtosContagem[registro.produto] = (produtosContagem[registro.produto] || 0) + parseInt(registro.quantidade);
                });
                
                const produtoMaisRetirado = Object.keys(produtosContagem).reduce((a, b) => 
                    produtosContagem[a] > produtosContagem[b] ? a : b, '-'
                );
                document.getElementById('produtoMaisRetirado').textContent = produtoMaisRetirado;
                
                // Setor com mais retiradas
                const setoresContagem = {};
                registrosRecentes.forEach(registro => {
                    setoresContagem[registro.setor] = (setoresContagem[registro.setor] || 0) + parseInt(registro.quantidade);
                });
                
                const setorMaisRetirado = Object.keys(setoresContagem).reduce((a, b) => 
                    setoresContagem[a] > setoresContagem[b] ? a : b, '-'
                );
                document.getElementById('setorMaisRetirado').textContent = setorMaisRetirado;
                
                // Colaborador mais ativo
                const colaboradoresContagem = {};
                registrosRecentes.forEach(registro => {
                    colaboradoresContagem[registro.colaborador] = (colaboradoresContagem[registro.colaborador] || 0) + parseInt(registro.quantidade);
                });
                
                const colaboradorMaisAtivo = Object.keys(colaboradoresContagem).reduce((a, b) => 
                    colaboradoresContagem[a] > colaboradoresContagem[b] ? a : b, '-'
                );
                document.getElementById('colaboradorMaisAtivo').textContent = colaboradorMaisAtivo;
            }
        }
        
        // Atualizar configurações
        function atualizarConfiguracoes() {
            document.getElementById('totalRegistrosConfig').textContent = estado.registros.length;
            
            // Calcular tamanho dos dados
            const dadosString = JSON.stringify(estado.registros);
            const tamanhoBytes = new Blob([dadosString]).size;
            const tamanhoKB = (tamanhoBytes / 1024).toFixed(2);
            document.getElementById('tamanhoDados').textContent = `${tamanhoKB} KB`;
        }
        
        // Toggle scanner (com QuaggaJS) - CORRIGIDA
        async function toggleScanner() {
            if (estado.scannerAtivo) {
                stopScanner();
                return;
            }
            
            const btn = document.getElementById('btnToggleScanner');
            const placeholder = document.getElementById('scanner-placeholder');
            const interactiveView = document.getElementById('interactive');
            const cameraControls = document.getElementById('cameraControls');
            const scanIndicator = document.getElementById('scanIndicator');
            
            try {
                // Mostrar indicador de carregamento
                mostrarToast('Iniciando leitor de código de barras...', false);
                
                // Verificar se o Quagga já foi inicializado
                if (!estado.quaggaInicializado) {
                    await new Promise((resolve, reject) => {
                        Quagga.init(quaggaConfig, function(err) {
                            if (err) {
                                reject(err);
                                return;
                            }
                            estado.quaggaInicializado = true;
                            resolve();
                        });
                    });
                }
                
                // Iniciar scanner
                Quagga.start();
                
                // Mostrar elementos da câmera
                placeholder.style.display = 'none';
                interactiveView.style.display = 'block';
                cameraControls.style.display = 'flex';
                scanIndicator.style.display = 'block';
                
                // Atualizar estado
                estado.scannerAtivo = true;
                btn.innerHTML = '<i class="fas fa-camera"></i> Leitor Ativo';
                btn.classList.add('scanner-active');
                
                // Configurar detecção de códigos
                Quagga.onDetected(function(result) {
                    if (!estado.scannerAtivo) return;
                    
                    const code = result.codeResult.code;
                    console.log("Código detectado:", code);
                    
                    // Preencher campo do código
                    document.getElementById('codigo').value = code;
                    
                    // Validar código
                    validarCodigoUnico();
                    
                    // Parar scanner após ler
                    stopScanner();
                    
                    // Feedback
                    mostrarToast(`Código lido: ${code}`, false);
                    
                    // Focar no próximo campo
                    setTimeout(() => {
                        document.getElementById('quantidade').focus();
                    }, 500);
                });
                
                // Adicionar timeout para scanner automático
                clearTimeout(estado.scanTimeout);
                estado.scanTimeout = setTimeout(() => {
                    if (estado.scannerAtivo) {
                        mostrarToast('Aponte a câmera para o código de barras', false, 'warning');
                    }
                }, 3000);
                
            } catch (error) {
                console.error('Erro no scanner:', error);
                mostrarToast('Erro ao acessar a câmera. Use digitação manual.', true);
                document.getElementById('codigo').focus();
                stopScanner();
            }
        }
        
        // Parar scanner
        function stopScanner() {
            if (!estado.scannerAtivo && !estado.quaggaInicializado) return;
            
            try {
                // Parar Quagga
                if (estado.quaggaInicializado) {
                    Quagga.stop();
                    Quagga.offDetected();
                }
                
                // Restaurar elementos
                document.getElementById('scanner-placeholder').style.display = 'block';
                document.getElementById('interactive').style.display = 'none';
                document.getElementById('cameraControls').style.display = 'none';
                document.getElementById('scanIndicator').style.display = 'none';
                
                // Atualizar estado
                estado.scannerAtivo = false;
                const btn = document.getElementById('btnToggleScanner');
                btn.innerHTML = '<i class="fas fa-camera"></i> Ativar Leitor de Código de Barras';
                btn.classList.remove('scanner-active');
                
                // Limpar timeout
                clearTimeout(estado.scanTimeout);
                
            } catch (error) {
                console.error("Erro ao parar scanner:", error);
            }
        }
        
        // Capturar manualmente (fallback)
        function capturarManualmente() {
            if (!estado.scannerAtivo) return;
            
            mostrarToast('Modo de captura manual ativado. Aponte para o código e clique novamente.', false, 'warning');
            
            // Em produção real, você implementaria captura de imagem
            // Aqui simularemos com um código aleatório
            setTimeout(() => {
                if (estado.scannerAtivo) {
                    // Gerar código EAN-13 aleatório para simulação
                    const codigoSimulado = '789' + Math.floor(100000000 + Math.random() * 900000000);
                    document.getElementById('codigo').value = codigoSimulado;
                    
                    // Validar código
                    validarCodigoUnico();
                    
                    // Parar scanner
                    stopScanner();
                    
                    // Feedback
                    mostrarToast(`Código simulado: ${codigoSimulado}`, false);
                    
                    // Focar no próximo campo
                    document.getElementById('quantidade').focus();
                }
            }, 2000);
        }
        
        // Validar formulário
        function validarFormulario() {
            let valido = true;
            
            // Obter valores
            const produto = document.getElementById('produto').value.trim();
            const codigo = document.getElementById('codigo').value.trim();
            const quantidade = document.getElementById('quantidade').value;
            const setor = document.getElementById('setor').value.trim();
            const colaborador = document.getElementById('colaborador').value.trim();
            
            // Validar produto
            if (produto === '') {
                mostrarErro('produtoError');
                valido = false;
            } else {
                esconderErro('produtoError');
            }
            
            // Validar código
            if (codigo === '') {
                mostrarErro('codigoError');
                valido = false;
            } else {
                esconderErro('codigoError');
            }
            
            // Validar quantidade
            const qtdNum = parseInt(quantidade);
            if (isNaN(qtdNum) || qtdNum < 1 || qtdNum > 999) {
                mostrarErro('quantidadeError');
                valido = false;
            } else {
                esconderErro('quantidadeError');
            }
            
            // Validar setor
            if (setor === '') {
                mostrarErro('setorError');
                valido = false;
            } else {
                esconderErro('setorError');
            }
            
            // Validar colaborador
            if (colaborador === '') {
                mostrarErro('colaboradorError');
                valido = false;
            } else {
                esconderErro('colaboradorError');
            }
            
            // Validar código único
            if (!validarCodigoUnico()) {
                valido = false;
            }
            
            // Se válido, mostrar modal de confirmação
            if (valido) {
                mostrarModalConfirmacao(produto, codigo, quantidade, setor, colaborador);
            }
            
            return valido;
        }
        
        // Validar código único
        function validarCodigoUnico() {
            const codigo = document.getElementById('codigo').value.trim();
            const hoje = new Date().toDateString();
            
            // Verificar se código já foi registrado hoje
            if (codigo !== '' && estado.codigosRegistradosHoje.has(codigo)) {
                mostrarErro('codigoDuplicadoError');
                return false;
            } else {
                esconderErro('codigoDuplicadoError');
                return true;
            }
        }
        
        // Validar quantidade
        function validarQuantidade() {
            const quantidade = document.getElementById('quantidade').value;
            const qtdNum = parseInt(quantidade);
            
            if (isNaN(qtdNum) || qtdNum < 1 || qtdNum > 999) {
                mostrarErro('quantidadeError');
                return false;
            } else {
                esconderErro('quantidadeError');
                return true;
            }
        }
        
        // Mostrar modal de confirmação
        function mostrarModalConfirmacao(produto, codigo, quantidade, setor, colaborador) {
            document.getElementById('confirmProduto').textContent = produto;
            document.getElementById('confirmCodigo').textContent = codigo;
            document.getElementById('confirmQuantidade').textContent = `${quantidade} unidade(s)`;
            document.getElementById('confirmSetor').textContent = setor;
            document.getElementById('confirmColaborador').textContent = colaborador;
            
            document.getElementById('confirmModal').style.display = 'flex';
        }
        
        // Fechar modal
        function fecharModal() {
            document.getElementById('confirmModal').style.display = 'none';
        }
        
        // Salvar registro
        function salvarRegistro() {
            // Obter valores do formulário
            const produto = document.getElementById('produto').value.trim();
            const codigo = document.getElementById('codigo').value.trim();
            const quantidade = document.getElementById('quantidade').value;
            const setor = document.getElementById('setor').value.trim();
            const colaborador = document.getElementById('colaborador').value.trim();
            const dataHora = new Date().toISOString();
            const id = Date.now().toString() + Math.random().toString(36).substr(2, 9);
            
            // Criar objeto de registro
            const registro = {
                id,
                produto,
                codigo,
                quantidade: parseInt(quantidade),
                setor,
                colaborador,
                dataHora
            };
            
            // Adicionar sugestões
            adicionarSugestao('produto', produto);
            adicionarSugestao('setor', setor);
            adicionarSugestao('colaborador', colaborador);
            
            // Adicionar ao estado
            estado.registros.push(registro);
            estado.codigosRegistradosHoje.add(codigo);
            
            // Salvar no localStorage
            localStorage.setItem('registrosProdutos', JSON.stringify(estado.registros));
            
            // Fechar modal
            fecharModal();
            
            // Limpar formulário
            limparFormulario();
            
            // Mostrar feedback
            mostrarToast('Registro salvo com sucesso!', false);
            
            // Atualizar listas
            carregarRegistros();
            atualizarResumo();
            atualizarConfiguracoes();
            
            // Mudar para aba de registros
            document.querySelector('.nav-item[data-tab="registros"]').click();
        }
        
        // Limpar formulário
        function limparFormulario() {
            document.getElementById('produto').value = '';
            document.getElementById('codigo').value = '';
            document.getElementById('quantidade').value = '1';
            document.getElementById('setor').value = '';
            document.getElementById('colaborador').value = '';
            
            // Limpar erros
            esconderErro('produtoError');
            esconderErro('codigoError');
            esconderErro('quantidadeError');
            esconderErro('setorError');
            esconderErro('colaboradorError');
            esconderErro('codigoDuplicadoError');
            
            // Focar no primeiro campo
            document.getElementById('produto').focus();
        }
        
        // Mostrar modal de exclusão
        function mostrarModalExclusao(id) {
            estado.registroParaDeletar = id;
            
            const registro = estado.registros.find(r => r.id === id);
            if (!registro) return;
            
            const data = new Date(registro.dataHora);
            const dataFormatada = data.toLocaleDateString('pt-BR');
            const horaFormatada = data.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            
            document.getElementById('deleteRegistroInfo').innerHTML = `
                <strong>${registro.produto}</strong><br>
                Código: ${registro.codigo}<br>
                Quantidade: ${registro.quantidade} un.<br>
                Data: ${dataFormatada} ${horaFormatada}
            `;
            
            document.getElementById('deleteModal').style.display = 'flex';
        }
        
        // Fechar modal de exclusão
        function fecharDeleteModal() {
            estado.registroParaDeletar = null;
            document.getElementById('deleteModal').style.display = 'none';
        }
        
        // Confirmar exclusão
        function confirmarExclusao() {
            if (!estado.registroParaDeletar) return;
            
            // Encontrar índice do registro
            const index = estado.registros.findIndex(r => r.id === estado.registroParaDeletar);
            
            if (index !== -1) {
                // Remover do estado
                estado.registros.splice(index, 1);
                
                // Salvar no localStorage
                localStorage.setItem('registrosProdutos', JSON.stringify(estado.registros));
                
                // Atualizar códigos registrados hoje
                atualizarCodigosRegistradosHoje();
                
                // Atualizar UI
                carregarRegistros();
                atualizarResumo();
                atualizarConfiguracoes();
                
                // Feedback
                mostrarToast('Registro excluído com sucesso!', false);
            }
            
            fecharDeleteModal();
        }
        
        // Mostrar modal de limpeza
        function mostrarModalLimpeza() {
            document.getElementById('clearDataCount').textContent = estado.registros.length;
            document.getElementById('clearDataModal').style.display = 'flex';
        }
        
        // Fechar modal de limpeza
        function fecharClearModal() {
            document.getElementById('clearDataModal').style.display = 'none';
        }
        
        // Confirmar limpeza de dados
        function confirmarLimpeza() {
            // Limpar todos os dados
            estado.registros = [];
            estado.codigosRegistradosHoje.clear();
            estado.sugestoes = {
                produtos: [],
                setores: [],
                colaboradores: []
            };
            
            // Limpar localStorage
            localStorage.removeItem('registrosProdutos');
            localStorage.removeItem('sugestoesBaixaPro');
            
            // Atualizar UI
            carregarRegistros();
            atualizarResumo();
            atualizarConfiguracoes();
            
            // Feedback
            mostrarToast('Todos os dados foram limpos!', false);
            
            fecharClearModal();
        }
        
        // Mostrar detalhes do registro
        function mostrarDetalhesRegistro(id) {
            const registro = estado.registros.find(r => r.id === id);
            if (!registro) return;
            
            const data = new Date(registro.dataHora);
            const dataFormatada = data.toLocaleDateString('pt-BR');
            const horaFormatada = data.toLocaleTimeString('pt-BR');
            
            alert(`📋 Detalhes do Registro\n\n` +
                  `🏷️ Produto: ${registro.produto}\n` +
                  `📊 Código: ${registro.codigo}\n` +
                  `📦 Quantidade: ${registro.quantidade} un.\n` +
                  `🏭 Setor: ${registro.setor}\n` +
                  `👤 Colaborador: ${registro.colaborador}\n` +
                  `📅 Data/Hora: ${dataFormatada} ${horaFormatada}\n` +
                  `🆔 ID: ${registro.id}`);
        }
        
        // Exportar PDF - CORRIGIDA E MELHORADA
        function exportarPDF() {
            mostrarToast('Gerando relatório em PDF...', false);
            
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Configurações do documento
                const pageWidth = doc.internal.pageSize.width;
                const hoje = new Date().toLocaleDateString('pt-BR');
                
                // Cabeçalho
                doc.setFontSize(20);
                doc.setTextColor(37, 99, 235);
                doc.text("BaixaPro - Relatório de Produção", pageWidth / 2, 15, { align: 'center' });
                
                doc.setFontSize(12);
                doc.setTextColor(100, 100, 100);
                doc.text(`Gerado em: ${hoje}`, pageWidth / 2, 23, { align: 'center' });
                
                // Linha separadora
                doc.setDrawColor(37, 99, 235);
                doc.setLineWidth(0.5);
                doc.line(15, 28, pageWidth - 15, 28);
                
                // Resumo
                doc.setFontSize(16);
                doc.setTextColor(0, 0, 0);
                doc.text("Resumo", 15, 38);
                
                doc.setFontSize(12);
                doc.text(`Total de Registros: ${estado.registros.length}`, 15, 48);
                
                // Tabela de registros
                const registrosParaExportar = estado.registros.slice().reverse(); // Mais recentes primeiro
                
                const headers = [["Produto", "Código", "Quantidade", "Setor", "Colaborador", "Data"]];
                const data = registrosParaExportar.map(registro => {
                    const data = new Date(registro.dataHora);
                    return [
                        registro.produto,
                        registro.codigo,
                        registro.quantidade.toString(),
                        registro.setor,
                        registro.colaborador,
                        data.toLocaleDateString('pt-BR')
                    ];
                });
                
                doc.autoTable({
                    head: headers,
                    body: data,
                    startY: 55,
                    theme: 'grid',
                    headStyles: { fillColor: [37, 99, 235], textColor: [255, 255, 255] },
                    alternateRowStyles: { fillColor: [240, 240, 240] },
                    margin: { left: 15, right: 15 }
                });
                
                // Rodapé
                const finalY = doc.lastAutoTable.finalY + 10;
                doc.setFontSize(10);
                doc.setTextColor(150, 150, 150);
                doc.text("Sistema BaixaPro - Relatório gerado automaticamente", pageWidth / 2, finalY, { align: 'center' });
                
                // Salvar PDF
                const nomeArquivo = `baixapro_relatorio_${new Date().toISOString().slice(0,10)}.pdf`;
                doc.save(nomeArquivo);
                
                mostrarToast('PDF gerado com sucesso!', false);
                
            } catch (error) {
                console.error('Erro ao gerar PDF:', error);
                mostrarToast('Erro ao gerar PDF. Tente novamente.', true);
            }
        }
        
        // Exportar backup
        function exportarBackup() {
            const data = {
                registros: estado.registros,
                sugestoes: estado.sugestoes,
                dataExportacao: new Date().toISOString(),
                versao: '2.0'
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `backup_baixapro_${new Date().toISOString().slice(0,10)}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            mostrarToast('Backup exportado com sucesso!', false);
        }
        
        // Importar backup
        function importarBackup(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    // Validar estrutura do backup
                    if (!data.registros || !Array.isArray(data.registros)) {
                        throw new Error('Formato de backup inválido');
                    }
                    
                    // Confirmar importação
                    if (confirm(`Deseja importar ${data.registros.length} registros?\nEsta ação irá substituir os dados atuais.`)) {
                        estado.registros = data.registros;
                        estado.sugestoes = data.sugestoes || {
                            produtos: [],
                            setores: [],
                            colaboradores: []
                        };
                        
                        // Salvar no localStorage
                        localStorage.setItem('registrosProdutos', JSON.stringify(estado.registros));
                        localStorage.setItem('sugestoesBaixaPro', JSON.stringify(estado.sugestoes));
                        
                        // Atualizar UI
                        atualizarCodigosRegistradosHoje();
                        carregarRegistros();
                        atualizarResumo();
                        atualizarConfiguracoes();
                        
                        mostrarToast(`Backup importado com sucesso! ${data.registros.length} registros restaurados.`, false);
                    }
                } catch (error) {
                    console.error('Erro ao importar backup:', error);
                    mostrarToast('Erro ao importar backup. Arquivo inválido.', true);
                }
                
                // Limpar input
                event.target.value = '';
            };
            
            reader.readAsText(file);
        }
        
        // Compartilhar relatório
        function compartilharRelatorio() {
            if (navigator.share) {
                const hoje = new Date().toLocaleDateString('pt-BR');
                const totalItens = estado.registros.reduce((total, registro) => total + parseInt(registro.quantidade), 0);
                
                navigator.share({
                    title: `BaixaPro - Relatório ${hoje}`,
                    text: `Relatório de baixa de produtos:\nTotal de registros: ${estado.registros.length}\nTotal de itens: ${totalItens}\nGerado em ${hoje}`,
                    url: window.location.href
                })
                .then(() => mostrarToast('Relatório compartilhado!', false))
                .catch(error => {
                    if (error.name !== 'AbortError') {
                        mostrarToast('Erro ao compartilhar', true);
                    }
                });
            } else {
                // Fallback para copiar para área de transferência
                const hoje = new Date().toLocaleDateString('pt-BR');
                const totalItens = estado.registros.reduce((total, registro) => total + parseInt(registro.quantidade), 0);
                const texto = `BaixaPro - Relatório ${hoje}\n\nTotal de registros: ${estado.registros.length}\nTotal de itens: ${totalItens}\nGerado em ${hoje}`;
                
                navigator.clipboard.writeText(texto)
                    .then(() => mostrarToast('Relatório copiado para área de transferência!', false))
                    .catch(() => mostrarToast('Copie manualmente os dados do resumo', true));
            }
        }
        
        // Funções auxiliares
        function mostrarErro(id) {
            document.getElementById(id).style.display = 'block';
            const fieldId = id.replace('Error', '');
            if (document.getElementById(fieldId)) {
                document.getElementById(fieldId).classList.add('error');
            }
        }
        
        function esconderErro(id) {
            document.getElementById(id).style.display = 'none';
            const fieldId = id.replace('Error', '');
            if (document.getElementById(fieldId)) {
                document.getElementById(fieldId).classList.remove('error');
            }
        }
        
        function mostrarToast(mensagem, isError, type = '') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            toastMessage.textContent = mensagem;
            
            // Resetar classes
            toast.className = 'toast';
            
            if (isError) {
                toast.classList.add('error');
                toast.querySelector('i').className = 'fas fa-exclamation-circle';
            } else if (type === 'warning') {
                toast.classList.add('warning');
                toast.querySelector('i').className = 'fas fa-exclamation-triangle';
            } else {
                toast.querySelector('i').className = 'fas fa-check';
            }
            
            toast.style.display = 'flex';
            
            setTimeout(() => {
                toast.style.display = 'none';
            }, 3000);
        }
        
        // Limpar scanner quando a página for fechada
        window.addEventListener('beforeunload', stopScanner);
        window.addEventListener('pagehide', stopScanner);
        
        // Prevenir zoom em dispositivos móveis
        document.addEventListener('touchstart', function(event) {
            if (event.touches.length > 1) {
                event.preventDefault();
            }
        }, { passive: false });
        
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function(event) {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);
    </script>
</body>
</html>